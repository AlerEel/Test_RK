# Подробная структура и описание проекта

## Общая структура проекта

- `app.py` — основной скрипт запуска: автоматическое получение заголовков, запуск парсера, сохранение данных в БД, инструкция по запуску веб-интерфейса.
- `scripts/` — вспомогательные скрипты:
    - `inspections_parser.py` — основной парсер API Госуслуг (ООП, устойчивость к ошибкам, логгирование).
    - `headers_extractor.py` — автоматическое получение заголовков для API через Playwright.
    - `load_to_sqlite.py` — загрузка данных в SQLite (ООП).
    - `server.py` — FastAPI сервер, отдаёт веб-интерфейс и статику.
- `data/` — база данных SQLite (`inspections.db`).
- `templates/` — HTML-шаблоны (Jinja2 + Bootstrap).
- `static/` — локальные CSS/JS (Bootstrap и др.).

---

## Файл: app.py

**Назначение:**
Главная точка входа. Автоматически получает заголовки для API, запускает парсер, сохраняет данные в БД, выводит инструкцию по запуску веб-интерфейса.

**Ключевые элементы:**
- Импортирует:
  - `GosuslugiExtractor` (извлечение заголовков через браузер)
  - `GosuslugiInspectionsParser`, `load_to_sqlite` (парсинг и сохранение)
  - `run_server` (запуск FastAPI)
- Проверяет наличие папки `data`, создаёт при необходимости.
- Запускает извлечение заголовков (эмулирует браузер, кликает по кнопке "Найти" на сайте Госуслуг).
- Если заголовки получены — запускает парсер, сохраняет результат в `data/inspections.db`.
- Если данных нет — выводит сообщение.
- После завершения — выводит инструкцию по запуску сайта и запускает сервер.

---

## Файл: scripts/inspections_parser.py

**Назначение:**
Парсер API Госуслуг. Получает данные о проверках, устойчив к ошибкам структуры, сохраняет результат в БД.

### Классы и функции:

#### class BaseAPIParser(ABC)
- Абстрактный базовый класс для парсинга API с пагинацией.
- Основные методы:
  - `__init__`: инициализация (заголовки, лимиты, счётчики ошибок).
  - `get_url`, `get_params`, `get_payload`, `process_item`: абстрактные методы, реализуются в наследниках.
  - `get_retryable_status_codes`: возвращает список кодов ошибок, при которых стоит повторять запрос.
  - `fetch_page`: выполняет POST-запрос с повторными попытками, логгирует статусы, возвращает JSON-ответ.
  - `run`: основной цикл пагинации, обрабатывает страницы, вызывает `process_item` для каждого элемента, логгирует пропуски и ошибки, возвращает список обработанных данных.
  - `safe_get`: безопасно извлекает значение по ключу из словаря (если не словарь — возвращает default).

#### class GosuslugiInspectionsParser(BaseAPIParser)
- Конкретная реализация для API Госуслуг.
- Методы:
  - `get_url`: возвращает URL API.
  - `get_params`: параметры запроса (номер страницы, размер страницы).
  - `get_payload`: формирует тело POST-запроса (фильтры по дате и др.).
  - `format_status`: форматирует статус проверки (учитывает отмену, завершение, основания изменений).
  - `format_result`: форматирует результат проверки (выявлены/не выявлены нарушения).
  - `process_item`: извлекает и форматирует все нужные поля из одного элемента ответа API, устойчив к ошибкам структуры.

#### def load_to_sqlite(data, db_path)
- Загружает список словарей в SQLite через класс SqliteLoader.
- Логгирует процесс, обрабатывает ошибки.

#### def main(headers)
- Запускает парсер с переданными заголовками, сохраняет результат в БД.

---

## Файл: scripts/headers_extractor.py

**Назначение:**
Извлекает необходимые HTTP-заголовки и тело запроса для API Госуслуг через эмуляцию браузера (Playwright).

### Классы и функции:

#### class BaseExtractor(ABC)
- Абстрактный класс для извлечения данных с сайтов через браузер.
- Методы:
  - `__init__`: инициализация (headless, браузер, контекст, страница, словарь для захвата данных).
  - `get_target_keywords`, `get_start_url`, `navigate_and_trigger`: абстрактные методы для настройки логики наследника.
  - `setup_browser`: запускает браузер, создаёт контекст, открывает страницу.
  - `setup_route_handler`: настраивает перехват сетевых запросов (по ключевым словам и методу POST).
  - `wait_for_api_response`: ждёт ответа от API (статус 200).
  - `close`: закрывает браузер.
  - `run`: основной шаблонный метод (запуск браузера, переход, клик, перехват, возврат заголовков и тела запроса).

#### class GosuslugiExtractor(BaseExtractor)
- Реализация для сайта Госуслуг.
- Методы:
  - `get_target_keywords`: ключевые слова для поиска нужного запроса ("examinations/public/search").
  - `get_start_url`: стартовая страница.
  - `navigate_and_trigger`: логика перехода и клика по кнопке "Найти".

#### def main()
- Запускает процесс извлечения заголовков и тела запроса, выводит результат в консоль.
- Если заголовки получены — передаёт их в парсер.

---

## Файл: scripts/load_to_sqlite.py

**Назначение:**
Класс для загрузки данных в SQLite.

### Класс SqliteLoader
- `__init__`: принимает имя БД и таблицы, определяет структуру колонок.
- `create_table`: создаёт таблицу, если не существует.
- `insert_data_from_list`: очищает таблицу, вставляет новые данные из списка словарей, коммитит транзакцию.

---

## Файл: scripts/server.py

**Назначение:**
Асинхронный FastAPI сервер для просмотра данных из БД через веб-интерфейс.

### Ключевые элементы:
- Константы: путь к БД, размер страницы.
- FastAPI-приложение, подключение статики и шаблонов.
- `get_db_connection`: асинхронное подключение к SQLite с row_factory.
- Эндпоинт `/` (index):
  - Параметр page (номер страницы).
  - Считает общее число записей, вычисляет количество страниц.
  - Получает записи для текущей страницы.
  - Передаёт данные в шаблон `index.html`.
- `run_server`: запускает сервер с помощью uvicorn, патчит event loop через nest_asyncio для совместимости с Jupyter и др.

---

## Шаблон: templates/index.html

**Назначение:**
HTML-шаблон для отображения результатов проверок с пагинацией и современным дизайном.

### Ключевые элементы:
- Подключение Bootstrap через `/static/bootstrap.min.css`.
- Стилизация карточек, пагинации, заголовков.
- Для каждой записи из rows:
  - Отображает название организации, ОГРН, цель, статус (цвет зависит от значения), результат (цвет зависит от значения), дату начала.
- Пагинация: кнопки "Первая", "Назад", текущая страница, "Вперёд", "Последняя" (с учётом наличия страниц).
- Если записей нет — выводит предупреждение.
- Подключение Bootstrap JS через `/static/bootstrap.bundle.min.js`.

---

## Структура базы данных (data/inspections.db)

- Таблица `inspections`:
  - `id` (INTEGER PRIMARY KEY AUTOINCREMENT)
  - `entity_name` (TEXT) — название организации
  - `ogrn` (TEXT) — ОГРН
  - `purpose` (TEXT) — цель проверки
  - `status` (TEXT) — статус проверки (сформатирован)
  - `result` (TEXT) — результат проверки (сформатирован)
  - `examStartDate` (TEXT) — дата начала проверки

---

## Особенности и взаимодействие

- Все ключевые процессы (извлечение заголовков, парсинг, загрузка в БД, запуск сервера) автоматизированы и связаны через app.py.
- Парсер устойчив к ошибкам структуры данных, не теряет ни одной записи.
- Веб-интерфейс современный, с пагинацией, легко расширяется.
- Все классы и функции снабжены логгированием для отладки.
- Для работы требуется Python 3.8+, Playwright, FastAPI, Uvicorn, Jinja2, Requests, python-dateutil, aiosqlite.

---

## Взаимодействие файлов

- `app.py` связывает все компоненты: получает заголовки через `headers_extractor.py`, парсит данные через `inspections_parser.py`, сохраняет в БД через `load_to_sqlite.py`, запускает сервер через `server.py`.
- Все вспомогательные скрипты лежат в папке `scripts/` для удобства поддержки.
- Шаблоны и статика отделены для чистоты архитектуры.

---

## Примечания
- Для запуска парсинга: `python app.py`
- Для запуска веб-интерфейса: `python scripts/server.py`
- Все зависимости должны быть установлены (см. README.md) 